name: PR Emoji & Notion Update by Author

on:
  pull_request:
    types: [opened, edited, reopened]

jobs:
  update-notion-checkbox:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title and body, then update author-specific checkbox
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: |
          echo "ğŸ” ì‹œì‘: PR ì œëª©ê³¼ ë³¸ë¬¸ í™•ì¸"

          PR_TITLE=$(jq -r .pull_request.title "$GITHUB_EVENT_PATH")
          PR_BODY=$(jq -r .pull_request.body "$GITHUB_EVENT_PATH")
          PR_AUTHOR=$(jq -r .pull_request.user.login "$GITHUB_EVENT_PATH")

          echo "ğŸ“Œ PR Title: $PR_TITLE"
          echo "ğŸ‘¤ ì‘ì„±ì: $PR_AUTHOR"

          # âœ… ë° âŒ ì´ëª¨ì§€ ê°ì§€
          HAS_CHECK=$(echo "$PR_BODY" | grep -q "âœ…" && echo "yes" || echo "no")
          HAS_CROSS=$(echo "$PR_BODY" | grep -q "âŒ" && echo "yes" || echo "no")

          if [[ "$HAS_CHECK" == "yes" && "$HAS_CROSS" == "yes" ]]; then
            CHECKBOX_VALUE=false
            echo "âš ï¸ ë‘˜ ë‹¤ í¬í•¨ â†’ false"
          elif [[ "$HAS_CROSS" == "yes" ]]; then
            CHECKBOX_VALUE=false
            echo "âŒ í¬í•¨ â†’ false"
          elif [[ "$HAS_CHECK" == "yes" ]]; then
            CHECKBOX_VALUE=true
            echo "âœ… í¬í•¨ â†’ true"
          else
            echo "âš ï¸ ì´ëª¨ì§€ê°€ ì—†ì–´ ìŠ¤í‚µí•©ë‹ˆë‹¤."
            exit 0
          fi

          # ì‘ì„±ì â†’ ì²´í¬ë°•ìŠ¤ í•„ë“œ ë§¤í•‘
          case "$PR_AUTHOR" in
            "Eunjin3395") FIELD_NAME="ì€ì§„" ;;
            "KII1ua") FIELD_NAME="ì„±ìœ¤" ;;
            "dlchdaud123") FIELD_NAME="ì´ëª…" ;;
            "jaewon-ju") FIELD_NAME="ì¬ì›" ;;
            "3veryDay") FIELD_NAME="í˜„ì„œ" ;;
            *)
              echo "âŒ ì•Œ ìˆ˜ ì—†ëŠ” ì‘ì„±ì: $PR_AUTHOR"
              exit 1
              ;;
          esac

          echo "ğŸ§© ì ìš© ëŒ€ìƒ í•„ë“œ: $FIELD_NAME"

          # PR ì œëª©ì—ì„œ BOJ ë¬¸ì œ ë²ˆí˜¸ ì¶”ì¶œ
          PROBLEM_NO=$(echo "$PR_TITLE" | grep -oE '\[BOJ [0-9]+\]' | grep -oE '[0-9]+')
          if [ -z "$PROBLEM_NO" ]; then
            echo "âŒ PR ì œëª©ì—ì„œ ë¬¸ì œ ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

          echo "ğŸ”¢ ì¶”ì¶œëœ ë¬¸ì œ ë²ˆí˜¸: $PROBLEM_NO"

          # Notion DBì—ì„œ ë¬¸ì œ ë²ˆí˜¸ í•„ë“œ == ë¬¸ì œ ë²ˆí˜¸ì¸ í˜ì´ì§€ ê²€ìƒ‰
          PAGE_ID=$(curl -s -X POST "https://api.notion.com/v1/databases/$NOTION_DATABASE_ID/query" \
            -H "Authorization: Bearer $NOTION_API_KEY" \
            -H "Notion-Version: 2022-06-28" \
            -H "Content-Type: application/json" \
            --data '{
              "filter": {
                "property": "ë¬¸ì œ ë²ˆí˜¸",
                "title": {
                  "equals": "'"$PROBLEM_NO"'"
                }
              }
            }' | jq -r '.results[0].id')

          if [ "$PAGE_ID" = "null" ] || [ -z "$PAGE_ID" ]; then
            echo "âŒ Notionì—ì„œ ë¬¸ì œ ë²ˆí˜¸ $PROBLEM_NOì— í•´ë‹¹í•˜ëŠ” í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

          echo "âœ… ëŒ€ìƒ Notion í˜ì´ì§€ ID í™•ì¸ë¨"

          # í•´ë‹¹ ì²´í¬ë°•ìŠ¤ì™€ ì œì¶œ ì²´í¬ë°•ìŠ¤ ëª¨ë‘ ì—…ë°ì´íŠ¸
          SUBMIT_FIELD="ì œì¶œ$FIELD_NAME"
          echo "ğŸ“¦ ëŒ€ìƒ ì œì¶œ í•„ë“œ: $SUBMIT_FIELD"

          JSON_BODY=$(cat <<EOF
          {
            "properties": {
              "$FIELD_NAME": {
                "checkbox": $CHECKBOX_VALUE
              },
              "$SUBMIT_FIELD": {
                "checkbox": true
              }
            }
          }
          EOF
          )

          # ğŸ‘ JSON ë³¸ë¬¸ ì¶œë ¥
          echo "ğŸ“¤ Notion PATCH ìš”ì²­ ë³¸ë¬¸:"
          echo "$JSON_BODY"

          # ğŸ” PATCH ìš”ì²­ ì „ì†¡
          curl -s -o /dev/null -w "%{http_code}" -X PATCH "https://api.notion.com/v1/pages/$PAGE_ID" \
            -H "Authorization: Bearer $NOTION_API_KEY" \
            -H "Notion-Version: 2022-06-28" \
            -H "Content-Type: application/json" \
            --data "$JSON_BODY"

          echo "ğŸ‰ Notion ì—…ë°ì´íŠ¸ ì™„ë£Œ!!: $FIELD_NAME â†’ $CHECKBOX_VALUE"

          echo "ğŸ¯ Lambda API í˜¸ì¶œ ì‹œì‘"

          curl -s -o lambda_response.json -w "%{http_code}" -X POST https://p7vk9p47d0.execute-api.ap-northeast-2.amazonaws.com/api/save \
            -H "Content-Type: application/json" \
            -d "{\"prAuthor\": \"$PR_AUTHOR\", \"problemId\": \"$PROBLEM_NO\"}"

          echo "ğŸ“¬ Lambda ì‘ë‹µ:"
          cat lambda_response.json

          echo "ğŸ‰ Lambda API í˜¸ì¶œ ì™„ë£Œ!!: $PR_AUTHOR, $PROBLEM_NO"
